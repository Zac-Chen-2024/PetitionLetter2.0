# PetitionLetter 系统开发日志

## 1. Extraction 阶段优化 - 律师框架引入

**日期**: 2026-02-17

### 1.1 问题背景

系统原有的 Extraction 流程能够从 Exhibit 文档中提取证据片段(snippets)，但存在以下问题：

1. **只提取直接证据**: 只关注"申请人做了什么"，忽略了"为什么这很重要"
2. **缺少证据分层**: 没有区分 Claim(声明)、Proof(证明)、Significance(重要性)、Context(背景)
3. **论点碎片化**: 生成的论点过于分散，一个标准可能有20+个独立论点

### 1.2 律师视角分析

参考例文 `Yaruo Qu PetitionLetter.md`，专业移民律师的论证结构为：

```
每个 EB-1A 标准 = 1-3 个核心论点
每个论点 = Claim + Proof + Significance + Context + Conclusion
```

**关键发现**: USCIS 审查时最关注的是 **Significance 层**，即：
- Membership: 其他杰出会员是谁？(证明选择性)
- Published Material: 媒体发行量多少？获过什么奖？(证明是"major media")
- Original Contribution: 量化影响是什么？(证明"major significance")
- Leading Role: 组织有什么声誉？(证明"distinguished reputation")

### 1.3 优化方案

#### 阶段一：增强 Extraction (已完成)

**新增文件**:
- `evidence_requirements.py`: 律师框架的证据需求清单
- `evidence_checker.py`: 证据完整性检查器
- `argument_organizer.py`: 论点组织器

**修改文件**:
- `unified_extractor.py`:
  - 新增 `evidence_purpose` 字段: direct_proof / selectivity_proof / credibility_proof / impact_proof
  - 新增 `evidence_layer` 字段: claim / proof / significance / context
  - 增强 System Prompt，添加 SIGNIFICANCE 层提取模式

**优化效果**:
| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| Snippets | 154 | 178 |
| Significance层占比 | ~2% | 42% |
| Arguments | 35 | 55 |

#### 阶段二：论点组合 (进行中)

**问题**: 虽然现在能提取 Significance 层证据，但论点仍然碎片化：
- Membership: 9个论点 (例文: 1个)
- Original Contribution: 21个论点 (例文: 1个)

**解决方案**: 新增 `argument_composer.py`

**分组规则**:
| 标准 | 分组键 | 目标 |
|------|--------|------|
| Membership | 协会名称 | 1个协会 = 1个论点 |
| Published Material | 媒体名称 | 1个媒体 = 1个论点 |
| Original Contribution | 不分组 | 所有证据 = 1个整体论点 |
| Leading Role | 组织名称 | 1个组织 = 1个论点 |
| Awards | 奖项名称 | 1个奖项 = 1个论点 |

**输出结构**:
```json
{
  "title": "Ms. Qu's Membership in Shanghai Fitness Bodybuilding Association",
  "standard": "membership",
  "claim": [...],
  "proof": [...],
  "significance": [...],
  "context": [...],
  "exhibits": ["C-1", "C-2", "C-6"],
  "conclusion": "clearly meets 8 C.F.R. §204.5(h)(3)(ii)",
  "completeness": {"has_significance": true, "score": 100}
}
```

### 1.4 架构图

```
┌──────────────────────────────────────────────────────────────┐
│                     PetitionLetter 系统                       │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Exhibits (PDF)                                              │
│       │                                                      │
│       ▼                                                      │
│  ┌─────────────────────┐                                     │
│  │ unified_extractor   │  ← 增强: evidence_layer,            │
│  │                     │         evidence_purpose            │
│  └──────────┬──────────┘                                     │
│             │                                                │
│             ▼                                                │
│  ┌─────────────────────┐                                     │
│  │ Snippets (178个)    │  包含: claim/proof/significance     │
│  └──────────┬──────────┘                                     │
│             │                                                │
│             ▼                                                │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ argument_generator  │ ──► │ argument_composer   │ [新增]  │
│  │ (碎片化论点)         │     │ (结构化论点)         │        │
│  └─────────────────────┘     └──────────┬──────────┘        │
│                                         │                    │
│             ┌───────────────────────────┘                    │
│             ▼                                                │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ evidence_checker    │     │ Lawyer-style Output │        │
│  │ (完整性检查)         │     │ (Markdown/PDF)      │        │
│  └─────────────────────┘     └─────────────────────┘        │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 1.5 文件清单

| 文件 | 功能 | 状态 |
|------|------|------|
| `unified_extractor.py` | 统一提取器 | 已优化 |
| `evidence_requirements.py` | 证据需求清单 | 新增 |
| `evidence_checker.py` | 完整性检查器 | 新增 |
| `argument_organizer.py` | 论点组织器 (基础版) | 新增 |
| `argument_composer.py` | 论点组合器 (律师版) | 已完成 |

---

## 2. Human-in-the-Loop 审核功能

**日期**: 2026-02-17

### 2.1 问题背景

作为 HCI 项目，系统需要在自动化流程中引入人类参与环节，让用户可以：
- 审核 AI 生成的论点
- 决定保留/排除哪些论点
- 查看每个论点的完整性检查结果

### 2.2 设计方案

基于现有的四栏界面（DocumentViewer | EvidenceCardPool | ArgumentAssembly | StandardsPanel），
在 **ArgumentAssembly** 面板中添加审核模式：

```
┌────────────────────────────────────────────────────┐
│  Argument Assembly              [Review] [Generate] │
├────────────────────────────────────────────────────┤
│  ✓ 5 approved  ✗ 3 excluded  ○ 2 pending           │
├────────────────────────────────────────────────────┤
│  ┌─ AI: Recommend Keep ────────────────────────┐   │
│  │ Shanghai Fitness Bodybuilding Association    │   │
│  │ ✓ Has membership certificate                 │   │
│  │ ✓ Has membership criteria                    │   │
│  │ ✗ Has selectivity proof                      │   │
│  │ Completeness: ████████░░ 66%                 │   │
│  │ [✅ Keep] [❌ Exclude]                        │   │
│  └──────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
```

### 2.3 实现内容

#### 前端 (React/TypeScript)

**修改文件**: `types/index.ts`
- 新增 `QualificationCheck` 接口
- 新增 `ArgumentQualification` 接口
- 新增 `HumanDecision` 类型
- 修改 `Argument` 接口，添加 `qualification` 和 `humanDecision` 字段

**修改文件**: `components/ArgumentAssembly.tsx`
- 新增 `QualificationPanel` 组件，显示资格检查结果
- 新增 `reviewMode` 状态切换
- 添加审核统计显示（approved/excluded/pending）
- 添加 Keep/Exclude 决策按钮

#### 后端 (Python/FastAPI)

**新增文件**: `services/argument_qualifier.py`
- 定义各标准的资格检查规则
- 实现 `qualify_argument()` 函数
- 实现 `qualify_all_arguments()` 函数
- 实现 `get_qualification_summary()` 函数

**修改文件**: `routers/arguments.py`
- 修改 `GET /api/arguments/{project_id}` 端点
- 添加 `include_qualification` 参数

**修改文件**: `services/argument_generator.py`
- 添加 `load_snippets()` 方法

### 2.4 资格检查规则

| 标准 | 检查项 | 类型 |
|------|--------|------|
| **Membership** | 有会员证书 | Required |
| | 有入会标准 | Required |
| | 有选择性证明 (杰出会员) | Required |
| **Published Material** | 有关于申请人的报道 | Required |
| | 有媒体资质证明 | Required |
| **Original Contribution** | 有原创贡献描述 | Required |
| | 有影响力证明 | Required |
| | 有专家认可 | Optional |
| **Leading Role** | 有领导角色证据 | Required |
| | 有组织声誉证明 | Required |
| **Awards** | 有奖项证据 | Required |
| | 有国家/国际认可 | Required |
| | 有选择性证明 | Optional |

### 2.5 测试结果

对 55 个论点进行资格检查：
- **Keep**: 29 (53%)
- **Exclude**: 26 (47%)
- **Avg Completeness**: 38.2%

按标准分布：
| 标准 | Keep | Exclude |
|------|------|---------|
| original_contribution | 13 | 8 |
| published_material | 10 | 6 |
| leading_role | 3 | 4 |
| membership | 1 | 8 |
| awards | 1 | 0 |

### 2.6 下一步

1. 前端调用 API 获取 qualification 数据
2. 测试完整的审核流程
3. 添加合并论点功能

---

## 3. 多 LLM Provider 支持

**日期**: 2026-02-17

### 3.1 问题背景

系统原有的 LLM 调用只支持 OpenAI API，存在以下问题：
- GPT-4 成本较高
- 缺乏灵活性，无法切换不同提供商

### 3.2 设计方案

#### 架构设计

```
┌────────────────────────────────────────────────────┐
│                   Frontend                          │
│  ┌──────────────────────────────────────────────┐  │
│  │  Settings / Header                            │  │
│  │  LLM Provider: [DeepSeek ▼] [OpenAI]         │  │
│  └──────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────┐
│                   Backend                           │
│  ┌──────────────────────────────────────────────┐  │
│  │ llm_client.py                                 │  │
│  │                                               │  │
│  │  call_llm(prompt, provider="deepseek")       │  │
│  │       │                                       │  │
│  │       ├── provider="deepseek" → call_deepseek │  │
│  │       └── provider="openai"   → call_openai   │  │
│  └──────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┘
```

#### Provider 对比

| Provider | Model | 价格 | 特点 |
|----------|-------|------|------|
| **DeepSeek** | deepseek-chat | ¥1/百万token | 便宜，中文好 |
| **OpenAI** | gpt-4o-mini | $0.15/百万token | 稳定，JSON schema |
| **OpenAI** | gpt-4o | $5/百万token | 质量最高 |

### 3.3 实现内容 (已完成)

#### 后端修改

**修改文件**: `services/llm_client.py`
- 新增 `DEEPSEEK_CHAT_MODEL`, `DEEPSEEK_REASONER_MODEL` 常量
- 新增 `call_deepseek()` 函数 - DeepSeek API 调用
- 新增 `call_deepseek_text()` 函数 - DeepSeek 纯文本响应
- 新增 `call_llm()` 统一接口 - 根据 provider 参数分发
- 新增 `call_llm_text()` 统一文本接口
- 修改 `analyze_with_schema()` 和 `generate_prose()` 使用统一接口

**修改文件**: (所有使用 LLM 的服务)
- `unified_extractor.py`: `call_openai` → `call_llm`
- `argument_generator.py`: `call_openai` → `call_llm`
- `entity_merger.py`: `call_openai` → `call_llm`
- `snippet_extractor.py`: `call_openai` → `call_llm`
- `petition_writer.py`: `call_openai_text` → `call_llm_text`
- `relationship_analyzer.py`: `call_openai` → `call_llm`

### 3.4 前端 Provider 选择 (已完成)

#### 前端修改

**修改文件**: `types/index.ts`
- 新增 `LLMProvider` 类型
- 新增 `LLMProviderInfo` 接口

**修改文件**: `context/AppContext.tsx`
- 新增 `llmProvider` 状态 (localStorage 持久化)
- 新增 `setLlmProvider` 回调
- API 调用传递 `provider` 参数

**修改文件**: `components/Header.tsx`
- 新增 LLM Provider 下拉选择器

#### 后端修改 (支持 provider 参数)

**修改文件**: `routers/extraction.py`
- `ExtractionRequest` 添加 `provider` 字段

**修改文件**: `routers/arguments.py`
- `GenerateRequest` 添加 `provider` 字段

**修改文件**: `services/unified_extractor.py`
- `extract_exhibit_unified` 支持 `provider` 参数
- `extract_all_unified` 支持 `provider` 参数

**修改文件**: `services/entity_merger.py`
- `suggest_entity_merges` 支持 `provider` 参数

**修改文件**: `services/argument_generator.py`
- `generate_arguments` 支持 `provider` 参数
- `_smart_group_snippets` 支持 `provider` 参数

### 3.5 配置说明

在 `.env` 中配置 API Key：
```env
# DeepSeek (推荐，便宜)
DEEPSEEK_API_KEY=sk-xxx
DEEPSEEK_API_BASE=https://api.deepseek.com/v1

# OpenAI (备选)
OPENAI_API_KEY=sk-xxx
OPENAI_API_BASE=https://api.openai.com/v1
```

---

## 4. 连线聚焦互斥 Bug 修复

**日期**: 2026-02-17

### 4.1 问题

点击不同的 Argument 卡片时，旧的连线不消失，和新的连线重叠。

### 4.2 原因

当 `focusState` 从 `{type:'argument', id:'A'}` 变成 `{type:'argument', id:'B'}` 时：
- 条件 `focusState.type === 'argument'` 仍然为 TRUE
- React 复用同一个组件实例
- 没有 `key` 属性，React 无法识别需要重新创建

### 4.3 修复

**修改文件**: `components/ConnectionLines.tsx`

```tsx
// 添加 key 属性强制 React 重新创建组件
{focusState.type === 'argument' && focusState.id ? (
  <ArgumentConnectionLines key={focusState.id} argumentId={focusState.id} />
) : focusState.type === 'standard' && focusState.id ? (
  <StandardConnectionLines key={focusState.id} standardId={focusState.id} />
) : selectedSnippetId ? (
  <SnippetConnectionLines key={selectedSnippetId} snippetId={selectedSnippetId} />
) : null}
```

---

## 5. Argument Composer 泛化优化

**日期**: 2026-02-17

### 5.1 问题背景

`argument_composer.py` 中存在严重的过拟合问题，硬编码了特定案例 (yaruo_qu) 的数据：

| 位置 | 变量 | 问题 |
|------|------|------|
| 43-60 | `EXHIBIT_TO_MEDIA` | D1-D13 → 具体媒体名，仅适用于 yaruo_qu |
| 66-74 | `EXHIBIT_TO_ASSOCIATION` | C1-C7 → SFBA，仅适用于 yaruo_qu |
| 93-95 | `APPLICANT_NAME_VARIANTS` | yaruo qu, gaby 等，仅适用于 yaruo_qu |
| 98-101 | `ORGANIZATION_MERGE` | venus → yiqing，仅适用于 yaruo_qu |
| 189 | 代码 | "BAT Training System" 硬编码 |
| 192 | 代码 | "China Fitness Industry Achievement Award" 硬编码 |

### 5.2 泛化方案

将硬编码映射替换为 **LLM 动态分析层**：

```
┌─────────────────────────────────────────────────────────────┐
│                    泛化后架构                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  unified_extractor → snippets + entities                    │
│       │                                                      │
│       ▼                                                      │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ entity_analyzer     │ ──► │ project_metadata    │ [新增] │
│  │ (LLM 动态分析)       │     │ (JSON 配置)         │        │
│  └─────────────────────┘     └──────────┬──────────┘        │
│                                         │                    │
│             ┌───────────────────────────┘                    │
│             ▼                                                │
│  ┌─────────────────────┐                                     │
│  │ argument_composer   │  使用动态配置替代硬编码              │
│  │ (泛化版)            │                                     │
│  └─────────────────────┘                                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 实现内容 (已完成)

#### 新增文件: `services/entity_analyzer.py`

LLM 动态实体分析服务，功能：
- 分析项目中提取的 entities 和 snippets
- 自动识别申请人名字变体
- 生成 Exhibit → 实体映射 (媒体/协会/组织)
- 识别需要合并的实体
- 识别关键成就 (原创贡献、奖项)

核心函数：
```python
async def analyze_project_entities(
    project_id: str,
    applicant_name: str,
    provider: str = "deepseek",  # 或 "openai"
    force: bool = False
) -> Dict[str, Any]:
    """分析项目实体，生成 project_metadata.json"""
```

#### 重构文件: `services/argument_composer.py`

- **移除所有硬编码常量**：
  - `EXHIBIT_TO_MEDIA`
  - `EXHIBIT_TO_ASSOCIATION`
  - `APPLICANT_NAME_VARIANTS`
  - `ORGANIZATION_MERGE`
  - `QUALIFIED_ORGANIZATIONS`
  - `QUALIFIED_MEMBERSHIPS`

- **新增配置加载**：
  ```python
  class ArgumentComposer:
      def __init__(self, snippets, applicant_name, metadata=None):
          self.metadata = metadata or self._create_empty_metadata()
          self._init_mappings()  # 从配置初始化映射
  ```

- **保留通用 Fallback**：`DEFAULT_DISQUALIFIED_MEMBERSHIPS` (NSCA, ACE 等)

#### 修改文件: `routers/arguments.py`

- 导入 `analyze_project_entities`, `load_project_metadata`
- `/composed` 端点：
  - 先调用 `analyze_project_entities()` 获取/生成 metadata
  - 传递 metadata 给 `compose_project_arguments()`
  - 返回 `entity_analysis` 信息
- 支持 `force_analyze` 参数强制重新分析

### 5.4 project_metadata.json 结构

LLM 分析后生成的配置示例 (yaruo_qu 项目)：

```json
{
  "applicant": {
    "formal_name": "Yaruo Qu",
    "name_variants": ["Gaby Qu", "Ms. Yaruo Qu", "Coach Yaruo Qu"]
  },
  "exhibit_mappings": {
    "media": {
      "D1": "Sixth Tone",
      "D2": "The Jakarta Post",
      "D5": "China Sports Daily",
      "D9": "The Paper"
    },
    "associations": {
      "C1": "Shanghai Fitness Bodybuilding Association",
      "C6": "China Bodybuilding Association"
    },
    "organizations": {
      "F1": "Shanghai Yiqing Fitness Management Co., Ltd.",
      "F3": "Venus Weightlifting Club",
      "F6": "ISHTAR HEALTH PTE. LTD."
    }
  },
  "entity_merges": [
    {"canonical": "Venus Weightlifting Club", "variants": ["Venus Weightlifting", "VWC"]},
    {"canonical": "Shanghai Fitness Bodybuilding Association", "variants": ["SFBA"]}
  ],
  "disqualified_memberships": ["Level 1 Coach Certification", "NSCA Professional Membership"],
  "key_achievements": {
    "original_contribution": "Body Alignment Training (BAT)",
    "awards": ["Achievement Award in the Fitness Industry in China"]
  },
  "_metadata": {
    "generated_at": "2026-02-17T...",
    "provider": "openai",
    "entity_count": 243,
    "snippet_count": 178
  }
}
```

### 5.5 测试结果

| 指标 | 泛化前 | 泛化后 |
|------|--------|--------|
| Membership 论点 | 5 | 3 (NSCA 被过滤) |
| Published Material 论点 | 5 | 6 (按媒体分组) |
| Leading Role 论点 | 11 | 9 (实体合并) |

### 5.6 状态

**已完成** ✓

---

## 6. Multi-Agent Pipeline 架构升级

**日期**: 2026-02-17

### 6.1 问题背景

当前单一 LLM 调用架构存在以下问题：

| 问题 | 表现 | 例子 |
|------|------|------|
| **实体分类错误** | 句子片段被识别为组织 | "Her Effort", "On Behalf Of" |
| **垃圾论点过多** | Leading Role 有 10 个论点，7 个是垃圾 | 律师只写 2 个 |
| **缺乏质量过滤** | 所有提取结果都进入最终输出 | 无法区分强/弱论点 |

**对比例文**:

| Standard | 律师例文 | 当前系统 | 差距 |
|----------|---------|---------|------|
| Membership | 1 | 3 | +2 垃圾 |
| Published Material | 3 | 6 | +3 低质量 |
| Original Contribution | 1 | 1 | ✓ |
| Leading Role | 2 | 10 | +8 垃圾 |

### 6.2 Multi-Agent 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    Multi-Agent Pipeline                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  Stage 1: EXTRACTION AGENT (现有)                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ unified_extractor.py                                         │ │
│  │ Input: PDF text blocks                                       │ │
│  │ Output: Raw snippets + entities                              │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              ↓                                    │
│  Stage 2: ENTITY VALIDATION AGENT (新增)                         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ entity_validator.py                                          │ │
│  │ Input: Extracted entities                                    │ │
│  │ Output: Validated entities (过滤垃圾)                         │ │
│  │                                                               │ │
│  │ 验证规则:                                                     │ │
│  │   - ORGANIZATION: 必须含 Ltd/Inc/Club/Association/Co.        │ │
│  │   - MEDIA: 必须是已知媒体或含 Daily/Post/Times/News          │ │
│  │   - PERSON: 必须有完整姓名格式                                │ │
│  │   - 过滤句子片段和动词短语                                    │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              ↓                                    │
│  Stage 3: ENTITY ANALYZER (现有，增强)                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ entity_analyzer.py                                           │ │
│  │ Input: Validated entities + snippets                         │ │
│  │ Output: project_metadata.json                                │ │
│  │   - Exhibit mappings                                         │ │
│  │   - Entity merges                                            │ │
│  │   - Key achievements                                         │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              ↓                                    │
│  Stage 4: ARGUMENT COMPOSER (现有)                               │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ argument_composer.py                                         │ │
│  │ Input: Snippets + metadata                                   │ │
│  │ Output: Draft arguments per EB-1A standard                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              ↓                                    │
│  Stage 5: QUALITY SCORING AGENT (新增)                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ argument_scorer.py                                           │ │
│  │ Input: Draft arguments                                       │ │
│  │ Output: Scored arguments + recommendations                   │ │
│  │                                                               │ │
│  │ 评分维度:                                                     │ │
│  │   - 证据完整性: Claim + Proof + Significance?                │ │
│  │   - 证据强度: 有量化数据? 有第三方认证?                       │ │
│  │   - 组织声誉: 有 AAA 评级? 有政府认可?                        │ │
│  │   - 媒体资质: 有发行量数据? 有媒体奖项?                       │ │
│  │                                                               │ │
│  │ 输出建议:                                                     │ │
│  │   - STRONG: 推荐保留，证据充分                                │ │
│  │   - MEDIUM: 可保留，需补充证据                                │ │
│  │   - WEAK: 建议排除，证据不足                                  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              ↓                                    │
│  Stage 6: HUMAN REVIEW (HCI 核心)                                │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ Frontend UI                                                  │ │
│  │ - 显示 AI 评分和建议                                         │ │
│  │ - 用户决定: Keep / Exclude / Edit                            │ │
│  │ - 支持合并相似论点                                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 实现计划

| 阶段 | 任务 | 文件 | 状态 |
|------|------|------|------|
| 1 | Entity Validation Agent | `services/entity_validator.py` | 待开发 |
| 2 | Quality Scoring Agent | `services/argument_scorer.py` | 待开发 |
| 3 | Pipeline 整合 | `routers/arguments.py` | 待开发 |
| 4 | 前端 UI 支持 | `components/ArgumentAssembly.tsx` | 待开发 |

### 6.4 Entity Validation Agent 详细设计

#### 输入
```json
{
  "entities": [
    {"name": "Shanghai Yiqing Fitness Management Co., Ltd.", "type": "ORGANIZATION"},
    {"name": "Her Effort", "type": "ORGANIZATION"},
    {"name": "The Jakarta Post", "type": "MEDIA"},
    {"name": "On Behalf Of", "type": "ORGANIZATION"}
  ]
}
```

#### 验证规则

| 实体类型 | 验证规则 | 示例 |
|----------|---------|------|
| ORGANIZATION | 含公司后缀 (Ltd, Inc, Co., LLC, Club, Association) | ✓ "Shanghai Yiqing...Ltd." |
| ORGANIZATION | 或是已知组织类型 (Federation, Committee, School) | ✓ "China Weightlifting Association" |
| MEDIA | 含媒体关键词 (Daily, Post, Times, News, Journal) | ✓ "The Jakarta Post" |
| MEDIA | 或是已知媒体名 | ✓ "Sixth Tone" |
| PERSON | 至少 2 个词，首字母大写 | ✓ "Tom Liau" |
| 过滤 | 句子片段 (含动词 has/is/was/did) | ✗ "Qu Has Driven Forward..." |
| 过滤 | 介词短语 (On Behalf Of, In Addition To) | ✗ "On Behalf Of" |

#### 输出
```json
{
  "validated_entities": [
    {"name": "Shanghai Yiqing Fitness Management Co., Ltd.", "type": "ORGANIZATION", "valid": true},
    {"name": "The Jakarta Post", "type": "MEDIA", "valid": true}
  ],
  "filtered_entities": [
    {"name": "Her Effort", "reason": "No organization suffix"},
    {"name": "On Behalf Of", "reason": "Preposition phrase"}
  ]
}
```

### 6.5 Quality Scoring Agent 详细设计

#### 评分标准 (按 EB-1A 法规)

**Membership (8 C.F.R. §204.5(h)(3)(ii))**
| 检查项 | 权重 | 说明 |
|--------|------|------|
| 有会员证书 | 20% | Required |
| 有入会标准描述 | 20% | Required |
| 有选择性证明 (杰出会员) | 30% | Critical for approval |
| 有评审流程描述 | 15% | Strong evidence |
| 有量化选择性 (录取率) | 15% | Very strong |

**Published Material (8 C.F.R. §204.5(h)(3)(iii))**
| 检查项 | 权重 | 说明 |
|--------|------|------|
| 有关于申请人的文章 | 25% | Required |
| 有媒体发行量数据 | 25% | Proves "major" |
| 有媒体奖项/认可 | 25% | Proves reputation |
| 有媒体所有权/隶属 | 15% | Additional credibility |
| 是国际/全国性媒体 | 10% | Strong evidence |

**Leading Role (8 C.F.R. §204.5(h)(3)(viii))**
| 检查项 | 权重 | 说明 |
|--------|------|------|
| 有明确职位 (创始人/CEO/法定代表人) | 25% | Required |
| 有组织声誉证明 | 25% | Proves "distinguished" |
| 有领导成就描述 | 20% | Proves impact |
| 有第三方认可 | 15% | External validation |
| 有 AAA 评级/政府认可 | 15% | Very strong |

#### 输出格式
```json
{
  "argument_id": "leading_role_0",
  "title": "Ms. Qu's Leadership at Shanghai Yiqing",
  "score": 85,
  "grade": "STRONG",
  "checks": {
    "has_clear_title": {"pass": true, "evidence": "法定代表人、创始人"},
    "has_org_reputation": {"pass": true, "evidence": "AAA credit rating"},
    "has_achievements": {"pass": true, "evidence": "organized Venus Cup"},
    "has_third_party": {"pass": true, "evidence": "CWA endorsement"}
  },
  "recommendation": "KEEP",
  "suggestion": null
}
```

### 6.6 状态

**进行中** - 设计阶段

---

## 7. Evidence Type 分类模式优化

**日期**: 2026-02-17

### 7.1 问题背景

在专家评审过程中发现 `evidence_type` 分类存在误分类问题：

| 原始文本 | 被分类为 | 应该是 |
|---------|---------|--------|
| "sincerely invite you to attend the Entrepreneurship Sharing Salon" | `leadership` | `invitation` |
| KEDGE Business School 邀请信 | `leadership` | 邀请演讲 |

**根因分析**:

```
unified_extractor.py 使用严格 enum 约束:

"evidence_type": {
    "enum": ["award", "membership", "leadership", ...]  // 16 个固定选项
}

→ LLM 被迫选择最接近但不精确的类型
→ "invitation" 被归类为 "leadership"
→ 下游 argument_composer 无法区分
→ KEDGE 邀请信被错误用于 Leading Role criterion
```

### 7.2 专家讨论

**三种方案对比**:

| 方案 | 描述 | 优缺点 |
|------|------|--------|
| A. 扩展 enum | 增加 invitation, expert_recognition 等 | 仍有束缚，需不断扩展 |
| B. Human-in-Loop 新界面 | 额外审核流程 | 需要改前端，流程复杂 |
| **C. 自由分类 + 建议标签** | 移除 enum，给出建议标签 | 保持灵活，无需改前端 |

**用户观点**:
> "材料千变万化，是否应该给大语言模型更多的分类自由，毕竟人类也会 in the loop"

**专家结论**: 方案 C 最合理
- AI 做初步分类（有建议但不强制）
- 输出相对一致（因为有建议标签）
- 人可以修改（前端已有功能）

### 7.3 实现方案

**修改文件**: `services/unified_extractor.py`

**修改前 (严格 enum)**:
```python
"evidence_type": {
    "type": "string",
    "enum": [
        "award", "membership", "leadership", ...  # 16 个固定选项
    ]
}
```

**修改后 (自由分类 + 建议标签)**:
```python
"evidence_type": {
    "type": "string",
    "description": """Evidence type classification. Suggested labels (use these for consistency, or create more precise labels when needed):
- award: prizes, awards, honors for excellence
- membership: membership in selective associations
- invitation: invited to speak, participate, or share expertise
- leadership: leading or critical role IN an organization (not just invited)
- contribution: original contributions of major significance
- recommendation: recommendation from recognized expert
- media_coverage: news articles, media mentions about the applicant
- source_credibility: credentials of media/organization
- quantitative_impact: metrics, statistics showing impact
- other: use specific description if none of above fit precisely"""
}
```

### 7.4 预期效果

**修改前 (误分类)**:
```json
{
  "text": "sincerely invite you to attend the Entrepreneurship Sharing Salon...",
  "evidence_type": "leadership"  // 被迫选择
}
```

**修改后 (精确分类)**:
```json
{
  "text": "sincerely invite you to attend the Entrepreneurship Sharing Salon...",
  "evidence_type": "invitation"  // LLM 自然选择
}
```

### 7.5 下游处理

`argument_composer.py` 中需要使用关键词匹配而非精确匹配：

```python
def _matches_criterion(self, evidence_type: str, criterion: str) -> bool:
    """关键词匹配，适应自由分类"""
    leadership_keywords = ["leadership", "leading", "critical role", "director", "founder"]
    invitation_keywords = ["invitation", "invited", "speaking", "guest speaker"]

    if criterion == "leading_role":
        # invitation 不应归入 leadership
        if any(kw in evidence_type.lower() for kw in invitation_keywords):
            return False
        return any(kw in evidence_type.lower() for kw in leadership_keywords)
```

### 7.6 设计原则

| 层级 | 作用 | 灵活度 |
|-----|------|--------|
| **Extraction 层** | 给 LLM 最大自由，保留原始语义 | 高 |
| **Composition 层** | 关键词匹配，适应变体 | 中 |
| **Human Review** | 最终把关，可手动修改 | 完全 |

### 7.7 状态

**已完成** ✓

---

## 8. 混合管道架构 (Hybrid Pipeline)

**日期**: 2026-02-17

### 8.1 问题背景

运行泛化后的子论点组合发现新问题：

| 问题 | 表现 | 根因 |
|------|------|------|
| **Membership 分组混乱** | 章程条款变成独立论点 | Entity Analyzer 返回空映射 |
| **标题截断** | "Yaruo Qu Applied To Join The" | snippet 碎片化，缺上下文 |
| **Leading Role 改善** | 从 5 个减少到 2 个 ✓ | evidence_type 自由分类生效 |

### 8.2 专家讨论

**方案对比**:

| 方案 | 描述 | 解决的问题 |
|------|------|-----------|
| A. 精细化 Agent | 粗分类后再 LLM 精细分类 | 分类准确性 |
| B. 回溯源文件 | 组合时回溯 OCR 结果 | 信息完整性 |
| **C. 混合方案** | 两者结合 | 全部问题 |

**律师专家观点**:
> "从法律论证角度，最重要的是证据链完整。每个论点必须能追溯到原始 Exhibit，引用文字必须和原文一致。回溯源文件是必须的。"

**LLM 专家观点**:
> "精细化 Agent 解决分类准确性，回溯源文件解决信息完整性。当前问题两者都有，建议混合方案。"

### 8.3 混合管道架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Hybrid Pipeline                           │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  1. Extraction (现有)                                        │
│     └── 输出: snippets + evidence_type (粗分类)              │
│                                                              │
│  2. Context Enrichment (新增) ← 回溯源文件                   │
│     ├── 为每个 snippet 附加:                                 │
│     │   - 前后 blocks (上下文)                               │
│     │   - document_summary (文档类型)                        │
│     │   - exhibit_id → 原始 PDF 页码                         │
│     └── 输出: enriched_snippets                              │
│                                                              │
│  3. Refinement Agent (新增) ← 精细化                         │
│     ├── 输入: enriched_snippets (带上下文)                   │
│     ├── 任务: 按标准精细分类                                 │
│     │   - Membership: 识别具体协会名                         │
│     │   - Leading Role: 识别具体组织名                       │
│     │   - Published Material: 识别具体媒体名                 │
│     └── 输出: refined_snippets (精确分组键)                  │
│                                                              │
│  4. Composition (现有，增强)                                 │
│     ├── 使用精确分组键                                       │
│     ├── 生成完整标题 (用上下文)                              │
│     └── 保留原文引用链接                                     │
│                                                              │
│  5. Quality Scoring (待实现)                                 │
│     └── 评估论点强度                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 8.4 实现计划

| 阶段 | 任务 | 解决的问题 | 状态 |
|------|------|-----------|------|
| Phase 1 | 修复 Entity Analyzer | 映射返回空 | 进行中 |
| Phase 2 | Context Enrichment | 信息失真 | 待开发 |
| Phase 3 | Refinement Agent | 分类精度 | 待开发 |
| Phase 4 | Quality Scoring | 论点筛选 | 待开发 |

### 8.5 当前问题诊断

**Entity Analyzer 返回空映射的原因**:

```python
# entity_analyzer.py 调用 DeepSeek
result = await call_deepseek(...)

# DeepSeek 返回格式:
{
    "content": {  # 多了一层 wrapper!
        "applicant": {...},
        "exhibit_mappings": {...}
    }
}

# 期望格式:
{
    "applicant": {...},
    "exhibit_mappings": {...}
}
```

需要在 `entity_analyzer.py` 中处理 DeepSeek 的 wrapper 格式。

### 8.6 状态

**进行中** - Phase 1: 修复 Entity Analyzer

---

*日志由开发团队维护*
