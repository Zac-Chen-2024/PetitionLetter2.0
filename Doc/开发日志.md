# PetitionLetter 系统开发日志

## 1. Extraction 阶段优化 - 律师框架引入

**日期**: 2026-02-17

### 1.1 问题背景

系统原有的 Extraction 流程能够从 Exhibit 文档中提取证据片段(snippets)，但存在以下问题：

1. **只提取直接证据**: 只关注"申请人做了什么"，忽略了"为什么这很重要"
2. **缺少证据分层**: 没有区分 Claim(声明)、Proof(证明)、Significance(重要性)、Context(背景)
3. **论点碎片化**: 生成的论点过于分散，一个标准可能有20+个独立论点

### 1.2 律师视角分析

参考例文 `Yaruo Qu PetitionLetter.md`，专业移民律师的论证结构为：

```
每个 EB-1A 标准 = 1-3 个核心论点
每个论点 = Claim + Proof + Significance + Context + Conclusion
```

**关键发现**: USCIS 审查时最关注的是 **Significance 层**，即：
- Membership: 其他杰出会员是谁？(证明选择性)
- Published Material: 媒体发行量多少？获过什么奖？(证明是"major media")
- Original Contribution: 量化影响是什么？(证明"major significance")
- Leading Role: 组织有什么声誉？(证明"distinguished reputation")

### 1.3 优化方案

#### 阶段一：增强 Extraction (已完成)

**新增文件**:
- `evidence_requirements.py`: 律师框架的证据需求清单
- `evidence_checker.py`: 证据完整性检查器
- `argument_organizer.py`: 论点组织器

**修改文件**:
- `unified_extractor.py`:
  - 新增 `evidence_purpose` 字段: direct_proof / selectivity_proof / credibility_proof / impact_proof
  - 新增 `evidence_layer` 字段: claim / proof / significance / context
  - 增强 System Prompt，添加 SIGNIFICANCE 层提取模式

**优化效果**:
| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| Snippets | 154 | 178 |
| Significance层占比 | ~2% | 42% |
| Arguments | 35 | 55 |

#### 阶段二：论点组合 (进行中)

**问题**: 虽然现在能提取 Significance 层证据，但论点仍然碎片化：
- Membership: 9个论点 (例文: 1个)
- Original Contribution: 21个论点 (例文: 1个)

**解决方案**: 新增 `argument_composer.py`

**分组规则**:
| 标准 | 分组键 | 目标 |
|------|--------|------|
| Membership | 协会名称 | 1个协会 = 1个论点 |
| Published Material | 媒体名称 | 1个媒体 = 1个论点 |
| Original Contribution | 不分组 | 所有证据 = 1个整体论点 |
| Leading Role | 组织名称 | 1个组织 = 1个论点 |
| Awards | 奖项名称 | 1个奖项 = 1个论点 |

**输出结构**:
```json
{
  "title": "Ms. Qu's Membership in Shanghai Fitness Bodybuilding Association",
  "standard": "membership",
  "claim": [...],
  "proof": [...],
  "significance": [...],
  "context": [...],
  "exhibits": ["C-1", "C-2", "C-6"],
  "conclusion": "clearly meets 8 C.F.R. §204.5(h)(3)(ii)",
  "completeness": {"has_significance": true, "score": 100}
}
```

### 1.4 架构图

```
┌──────────────────────────────────────────────────────────────┐
│                     PetitionLetter 系统                       │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Exhibits (PDF)                                              │
│       │                                                      │
│       ▼                                                      │
│  ┌─────────────────────┐                                     │
│  │ unified_extractor   │  ← 增强: evidence_layer,            │
│  │                     │         evidence_purpose            │
│  └──────────┬──────────┘                                     │
│             │                                                │
│             ▼                                                │
│  ┌─────────────────────┐                                     │
│  │ Snippets (178个)    │  包含: claim/proof/significance     │
│  └──────────┬──────────┘                                     │
│             │                                                │
│             ▼                                                │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ argument_generator  │ ──► │ argument_composer   │ [新增]  │
│  │ (碎片化论点)         │     │ (结构化论点)         │        │
│  └─────────────────────┘     └──────────┬──────────┘        │
│                                         │                    │
│             ┌───────────────────────────┘                    │
│             ▼                                                │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ evidence_checker    │     │ Lawyer-style Output │        │
│  │ (完整性检查)         │     │ (Markdown/PDF)      │        │
│  └─────────────────────┘     └─────────────────────┘        │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 1.5 文件清单

| 文件 | 功能 | 状态 |
|------|------|------|
| `unified_extractor.py` | 统一提取器 | 已优化 |
| `evidence_requirements.py` | 证据需求清单 | 新增 |
| `evidence_checker.py` | 完整性检查器 | 新增 |
| `argument_organizer.py` | 论点组织器 (基础版) | 新增 |
| `argument_composer.py` | 论点组合器 (律师版) | 已完成 |

---

## 2. Human-in-the-Loop 审核功能

**日期**: 2026-02-17

### 2.1 问题背景

作为 HCI 项目，系统需要在自动化流程中引入人类参与环节，让用户可以：
- 审核 AI 生成的论点
- 决定保留/排除哪些论点
- 查看每个论点的完整性检查结果

### 2.2 设计方案

基于现有的四栏界面（DocumentViewer | EvidenceCardPool | ArgumentAssembly | StandardsPanel），
在 **ArgumentAssembly** 面板中添加审核模式：

```
┌────────────────────────────────────────────────────┐
│  Argument Assembly              [Review] [Generate] │
├────────────────────────────────────────────────────┤
│  ✓ 5 approved  ✗ 3 excluded  ○ 2 pending           │
├────────────────────────────────────────────────────┤
│  ┌─ AI: Recommend Keep ────────────────────────┐   │
│  │ Shanghai Fitness Bodybuilding Association    │   │
│  │ ✓ Has membership certificate                 │   │
│  │ ✓ Has membership criteria                    │   │
│  │ ✗ Has selectivity proof                      │   │
│  │ Completeness: ████████░░ 66%                 │   │
│  │ [✅ Keep] [❌ Exclude]                        │   │
│  └──────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
```

### 2.3 实现内容

#### 前端 (React/TypeScript)

**修改文件**: `types/index.ts`
- 新增 `QualificationCheck` 接口
- 新增 `ArgumentQualification` 接口
- 新增 `HumanDecision` 类型
- 修改 `Argument` 接口，添加 `qualification` 和 `humanDecision` 字段

**修改文件**: `components/ArgumentAssembly.tsx`
- 新增 `QualificationPanel` 组件，显示资格检查结果
- 新增 `reviewMode` 状态切换
- 添加审核统计显示（approved/excluded/pending）
- 添加 Keep/Exclude 决策按钮

#### 后端 (Python/FastAPI)

**新增文件**: `services/argument_qualifier.py`
- 定义各标准的资格检查规则
- 实现 `qualify_argument()` 函数
- 实现 `qualify_all_arguments()` 函数
- 实现 `get_qualification_summary()` 函数

**修改文件**: `routers/arguments.py`
- 修改 `GET /api/arguments/{project_id}` 端点
- 添加 `include_qualification` 参数

**修改文件**: `services/argument_generator.py`
- 添加 `load_snippets()` 方法

### 2.4 资格检查规则

| 标准 | 检查项 | 类型 |
|------|--------|------|
| **Membership** | 有会员证书 | Required |
| | 有入会标准 | Required |
| | 有选择性证明 (杰出会员) | Required |
| **Published Material** | 有关于申请人的报道 | Required |
| | 有媒体资质证明 | Required |
| **Original Contribution** | 有原创贡献描述 | Required |
| | 有影响力证明 | Required |
| | 有专家认可 | Optional |
| **Leading Role** | 有领导角色证据 | Required |
| | 有组织声誉证明 | Required |
| **Awards** | 有奖项证据 | Required |
| | 有国家/国际认可 | Required |
| | 有选择性证明 | Optional |

### 2.5 测试结果

对 55 个论点进行资格检查：
- **Keep**: 29 (53%)
- **Exclude**: 26 (47%)
- **Avg Completeness**: 38.2%

按标准分布：
| 标准 | Keep | Exclude |
|------|------|---------|
| original_contribution | 13 | 8 |
| published_material | 10 | 6 |
| leading_role | 3 | 4 |
| membership | 1 | 8 |
| awards | 1 | 0 |

### 2.6 下一步

1. 前端调用 API 获取 qualification 数据
2. 测试完整的审核流程
3. 添加合并论点功能

---

## 3. 多 LLM Provider 支持

**日期**: 2026-02-17

### 3.1 问题背景

系统原有的 LLM 调用只支持 OpenAI API，存在以下问题：
- GPT-4 成本较高
- 缺乏灵活性，无法切换不同提供商

### 3.2 设计方案

#### 架构设计

```
┌────────────────────────────────────────────────────┐
│                   Frontend                          │
│  ┌──────────────────────────────────────────────┐  │
│  │  Settings / Header                            │  │
│  │  LLM Provider: [DeepSeek ▼] [OpenAI]         │  │
│  └──────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┘
                         │
                         ▼
┌────────────────────────────────────────────────────┐
│                   Backend                           │
│  ┌──────────────────────────────────────────────┐  │
│  │ llm_client.py                                 │  │
│  │                                               │  │
│  │  call_llm(prompt, provider="deepseek")       │  │
│  │       │                                       │  │
│  │       ├── provider="deepseek" → call_deepseek │  │
│  │       └── provider="openai"   → call_openai   │  │
│  └──────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────┘
```

#### Provider 对比

| Provider | Model | 价格 | 特点 |
|----------|-------|------|------|
| **DeepSeek** | deepseek-chat | ¥1/百万token | 便宜，中文好 |
| **OpenAI** | gpt-4o-mini | $0.15/百万token | 稳定，JSON schema |
| **OpenAI** | gpt-4o | $5/百万token | 质量最高 |

### 3.3 实现内容 (已完成)

#### 后端修改

**修改文件**: `services/llm_client.py`
- 新增 `DEEPSEEK_CHAT_MODEL`, `DEEPSEEK_REASONER_MODEL` 常量
- 新增 `call_deepseek()` 函数 - DeepSeek API 调用
- 新增 `call_deepseek_text()` 函数 - DeepSeek 纯文本响应
- 新增 `call_llm()` 统一接口 - 根据 provider 参数分发
- 新增 `call_llm_text()` 统一文本接口
- 修改 `analyze_with_schema()` 和 `generate_prose()` 使用统一接口

**修改文件**: (所有使用 LLM 的服务)
- `unified_extractor.py`: `call_openai` → `call_llm`
- `argument_generator.py`: `call_openai` → `call_llm`
- `entity_merger.py`: `call_openai` → `call_llm`
- `snippet_extractor.py`: `call_openai` → `call_llm`
- `petition_writer.py`: `call_openai_text` → `call_llm_text`
- `relationship_analyzer.py`: `call_openai` → `call_llm`

### 3.4 前端 Provider 选择 (已完成)

#### 前端修改

**修改文件**: `types/index.ts`
- 新增 `LLMProvider` 类型
- 新增 `LLMProviderInfo` 接口

**修改文件**: `context/AppContext.tsx`
- 新增 `llmProvider` 状态 (localStorage 持久化)
- 新增 `setLlmProvider` 回调
- API 调用传递 `provider` 参数

**修改文件**: `components/Header.tsx`
- 新增 LLM Provider 下拉选择器

#### 后端修改 (支持 provider 参数)

**修改文件**: `routers/extraction.py`
- `ExtractionRequest` 添加 `provider` 字段

**修改文件**: `routers/arguments.py`
- `GenerateRequest` 添加 `provider` 字段

**修改文件**: `services/unified_extractor.py`
- `extract_exhibit_unified` 支持 `provider` 参数
- `extract_all_unified` 支持 `provider` 参数

**修改文件**: `services/entity_merger.py`
- `suggest_entity_merges` 支持 `provider` 参数

**修改文件**: `services/argument_generator.py`
- `generate_arguments` 支持 `provider` 参数
- `_smart_group_snippets` 支持 `provider` 参数

### 3.5 配置说明

在 `.env` 中配置 API Key：
```env
# DeepSeek (推荐，便宜)
DEEPSEEK_API_KEY=sk-xxx
DEEPSEEK_API_BASE=https://api.deepseek.com/v1

# OpenAI (备选)
OPENAI_API_KEY=sk-xxx
OPENAI_API_BASE=https://api.openai.com/v1
```

---

## 4. 连线聚焦互斥 Bug 修复

**日期**: 2026-02-17

### 4.1 问题

点击不同的 Argument 卡片时，旧的连线不消失，和新的连线重叠。

### 4.2 原因

当 `focusState` 从 `{type:'argument', id:'A'}` 变成 `{type:'argument', id:'B'}` 时：
- 条件 `focusState.type === 'argument'` 仍然为 TRUE
- React 复用同一个组件实例
- 没有 `key` 属性，React 无法识别需要重新创建

### 4.3 修复

**修改文件**: `components/ConnectionLines.tsx`

```tsx
// 添加 key 属性强制 React 重新创建组件
{focusState.type === 'argument' && focusState.id ? (
  <ArgumentConnectionLines key={focusState.id} argumentId={focusState.id} />
) : focusState.type === 'standard' && focusState.id ? (
  <StandardConnectionLines key={focusState.id} standardId={focusState.id} />
) : selectedSnippetId ? (
  <SnippetConnectionLines key={selectedSnippetId} snippetId={selectedSnippetId} />
) : null}
```

---

## 5. Argument Composer 泛化优化

**日期**: 2026-02-17

### 5.1 问题背景

`argument_composer.py` 中存在严重的过拟合问题，硬编码了特定案例 (yaruo_qu) 的数据：

| 位置 | 变量 | 问题 |
|------|------|------|
| 43-60 | `EXHIBIT_TO_MEDIA` | D1-D13 → 具体媒体名，仅适用于 yaruo_qu |
| 66-74 | `EXHIBIT_TO_ASSOCIATION` | C1-C7 → SFBA，仅适用于 yaruo_qu |
| 93-95 | `APPLICANT_NAME_VARIANTS` | yaruo qu, gaby 等，仅适用于 yaruo_qu |
| 98-101 | `ORGANIZATION_MERGE` | venus → yiqing，仅适用于 yaruo_qu |
| 189 | 代码 | "BAT Training System" 硬编码 |
| 192 | 代码 | "China Fitness Industry Achievement Award" 硬编码 |

### 5.2 泛化方案

将硬编码映射替换为 **LLM 动态分析层**：

```
┌─────────────────────────────────────────────────────────────┐
│                    泛化后架构                                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  unified_extractor → snippets + entities                    │
│       │                                                      │
│       ▼                                                      │
│  ┌─────────────────────┐     ┌─────────────────────┐        │
│  │ entity_analyzer     │ ──► │ project_metadata    │ [新增] │
│  │ (LLM 动态分析)       │     │ (JSON 配置)         │        │
│  └─────────────────────┘     └──────────┬──────────┘        │
│                                         │                    │
│             ┌───────────────────────────┘                    │
│             ▼                                                │
│  ┌─────────────────────┐                                     │
│  │ argument_composer   │  使用动态配置替代硬编码              │
│  │ (泛化版)            │                                     │
│  └─────────────────────┘                                     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 实现内容 (已完成)

#### 新增文件: `services/entity_analyzer.py`

LLM 动态实体分析服务，功能：
- 分析项目中提取的 entities 和 snippets
- 自动识别申请人名字变体
- 生成 Exhibit → 实体映射 (媒体/协会/组织)
- 识别需要合并的实体
- 识别关键成就 (原创贡献、奖项)

核心函数：
```python
async def analyze_project_entities(
    project_id: str,
    applicant_name: str,
    provider: str = "deepseek",  # 或 "openai"
    force: bool = False
) -> Dict[str, Any]:
    """分析项目实体，生成 project_metadata.json"""
```

#### 重构文件: `services/argument_composer.py`

- **移除所有硬编码常量**：
  - `EXHIBIT_TO_MEDIA`
  - `EXHIBIT_TO_ASSOCIATION`
  - `APPLICANT_NAME_VARIANTS`
  - `ORGANIZATION_MERGE`
  - `QUALIFIED_ORGANIZATIONS`
  - `QUALIFIED_MEMBERSHIPS`

- **新增配置加载**：
  ```python
  class ArgumentComposer:
      def __init__(self, snippets, applicant_name, metadata=None):
          self.metadata = metadata or self._create_empty_metadata()
          self._init_mappings()  # 从配置初始化映射
  ```

- **保留通用 Fallback**：`DEFAULT_DISQUALIFIED_MEMBERSHIPS` (NSCA, ACE 等)

#### 修改文件: `routers/arguments.py`

- 导入 `analyze_project_entities`, `load_project_metadata`
- `/composed` 端点：
  - 先调用 `analyze_project_entities()` 获取/生成 metadata
  - 传递 metadata 给 `compose_project_arguments()`
  - 返回 `entity_analysis` 信息
- 支持 `force_analyze` 参数强制重新分析

### 5.4 project_metadata.json 结构

LLM 分析后生成的配置示例 (yaruo_qu 项目)：

```json
{
  "applicant": {
    "formal_name": "Yaruo Qu",
    "name_variants": ["Gaby Qu", "Ms. Yaruo Qu", "Coach Yaruo Qu"]
  },
  "exhibit_mappings": {
    "media": {
      "D1": "Sixth Tone",
      "D2": "The Jakarta Post",
      "D5": "China Sports Daily",
      "D9": "The Paper"
    },
    "associations": {
      "C1": "Shanghai Fitness Bodybuilding Association",
      "C6": "China Bodybuilding Association"
    },
    "organizations": {
      "F1": "Shanghai Yiqing Fitness Management Co., Ltd.",
      "F3": "Venus Weightlifting Club",
      "F6": "ISHTAR HEALTH PTE. LTD."
    }
  },
  "entity_merges": [
    {"canonical": "Venus Weightlifting Club", "variants": ["Venus Weightlifting", "VWC"]},
    {"canonical": "Shanghai Fitness Bodybuilding Association", "variants": ["SFBA"]}
  ],
  "disqualified_memberships": ["Level 1 Coach Certification", "NSCA Professional Membership"],
  "key_achievements": {
    "original_contribution": "Body Alignment Training (BAT)",
    "awards": ["Achievement Award in the Fitness Industry in China"]
  },
  "_metadata": {
    "generated_at": "2026-02-17T...",
    "provider": "openai",
    "entity_count": 243,
    "snippet_count": 178
  }
}
```

### 5.5 测试结果

| 指标 | 泛化前 | 泛化后 |
|------|--------|--------|
| Membership 论点 | 5 | 3 (NSCA 被过滤) |
| Published Material 论点 | 5 | 6 (按媒体分组) |
| Leading Role 论点 | 11 | 9 (实体合并) |

### 5.6 状态

**已完成** ✓

---

*日志由开发团队维护*
